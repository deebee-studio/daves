<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dave Declaration Widget</title>
    
    <!-- Allow embedding in iframes -->
    <meta http-equiv="X-Frame-Options" content="ALLOWALL">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: transparent;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            text-align: center;
            width: 100%;
            max-width: 600px;
        }
        
        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-bottom: 20px;
            min-height: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .error-message.show {
            opacity: 1;
        }
        
        .debug-info {
            background: #f0f0f0;
            padding: 10px;
            margin: 10px 0;
            font-size: 12px;
            text-align: left;
            border-radius: 4px;
            display: none;
        }
        
        .debug-info.show {
            display: block;
        }
        
        .input-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .prefix, .suffix {
            color: #000;
            font-weight: 400;
        }
        
        .name-input {
            border: 2px solid #000;
            background: #fff;
            padding: 8px 16px;
            font-size: 40px;
            text-align: center;
            min-width: 200px;
            outline: none;
            font-family: inherit;
            transition: all 0.2s ease;
        }
        
        .name-input:focus {
            border-color: #000;
            box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
        }
        
        .connect-button {
            background: #000;
            color: #fff;
            border: none;
            border-radius: 40px;
            padding: 16px 48px;
            font-size: 18px;
            font-weight: 500;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 200px;
            font-family: inherit;
        }
        
        .connect-button:hover:not(:disabled) {
            background: #333;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .connect-button:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .connect-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .info-text {
            color: #666;
            font-size: 14px;
            margin-top: 20px;
        }
        
        .success-message {
            color: #28a745;
            font-size: 16px;
            margin-top: 20px;
            padding: 16px 24px;
            background: #d4edda;
            border-radius: 8px;
            display: none;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
            margin-left: 8px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 600px) {
            .input-wrapper {
                font-size: 28px;
            }
            
            .name-input {
                font-size: 28px;
                min-width: 150px;
                padding: 6px 12px;
            }
            
            .connect-button {
                font-size: 16px;
                padding: 14px 36px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="error-message" id="errorMessage"></div>
        <div class="debug-info" id="debugInfo"></div>
        
        <div class="input-wrapper">
            <span class="prefix">i_am_</span>
            <input 
                type="text" 
                class="name-input" 
                id="nameInput" 
                placeholder="your_name" 
                maxlength="14"
                autocomplete="off"
                spellcheck="false"
            >
            <span class="suffix">_dave</span>
        </div>
        
        <button class="connect-button" id="connectButton">CONNECT</button>
        
        <div class="info-text" id="infoText"></div>
        <div class="success-message" id="successMessage"></div>
    </div>

    <!-- Ethers.js -->
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    
    <script>
        // Debug mode - set to false for production
        const DEBUG = true;
        
        // Contract details
        const CONTRACT_ADDRESS = '0xB0731E7ea189c169640Fd890E5dcE9811040D0eA';
        const BASE_CHAIN_ID = '0x2105'; // 8453 in hex
        const BASE_CHAIN_ID_DEC = 8453;
        
        const CONTRACT_ABI = [
            "function cosignDeclaration(string memory chosenName) public",
            "function hasSigned(address) public view returns (bool)",
            "function signatureByAddress(address) public view returns (string)",
            "function nameExists(string) public view returns (bool)",
            "function isAllowlistActive() public view returns (bool)",
            "function timeUntilPublic() public view returns (uint256)"
        ];
        
        // State
        let provider = null;
        let signer = null;
        let contract = null;
        let connected = false;
        let userAddress = null;
        
        // Elements
        const connectButton = document.getElementById('connectButton');
        const nameInput = document.getElementById('nameInput');
        const errorMessage = document.getElementById('errorMessage');
        const infoText = document.getElementById('infoText');
        const successMessage = document.getElementById('successMessage');
        const debugInfo = document.getElementById('debugInfo');
        
        // Debug logging
        function debug(message, data = null) {
            console.log(`[Dave Widget] ${message}`, data || '');
            if (DEBUG) {
                debugInfo.classList.add('show');
                debugInfo.innerHTML += `${new Date().toLocaleTimeString()}: ${message}<br>`;
                if (data) {
                    debugInfo.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                }
            }
        }
        
        // Error handling
        function showError(message) {
            debug(`Error: ${message}`);
            errorMessage.textContent = message;
            errorMessage.classList.add('show');
            setTimeout(() => {
                errorMessage.classList.remove('show');
            }, 7000);
        }
        
        function clearMessages() {
            errorMessage.classList.remove('show');
            successMessage.style.display = 'none';
        }
        
        // Check environment
        debug('Widget loaded');
        debug('Ethereum available:', typeof window.ethereum !== 'undefined');
        
        // Connect wallet
        async function connectWallet() {
            try {
                clearMessages();
                debug('Starting connection...');
                
                // Check for wallet
                if (typeof window.ethereum === 'undefined') {
                    showError('Please install MetaMask or another Web3 wallet');
                    return;
                }
                
                connectButton.disabled = true;
                connectButton.innerHTML = 'CONNECTING...';
                
                // Request accounts with error handling
                let accounts;
                try {
                    debug('Requesting accounts...');
                    accounts = await window.ethereum.request({ 
                        method: 'eth_requestAccounts' 
                    });
                    debug('Accounts received:', accounts);
                } catch (err) {
                    debug('Account request failed:', err);
                    if (err.code === -32002) {
                        showError('Please unlock MetaMask');
                    } else if (err.code === 4001) {
                        showError('Connection rejected');
                    } else {
                        showError('Failed to get accounts');
                    }
                    connectButton.disabled = false;
                    connectButton.innerHTML = 'CONNECT';
                    return;
                }
                
                if (!accounts || accounts.length === 0) {
                    throw new Error('No accounts found');
                }
                
                // Get current chain
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                debug('Current chain:', chainId);
                
                // Switch to Base if needed
                if (chainId !== BASE_CHAIN_ID) {
                    debug('Switching to Base...');
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: BASE_CHAIN_ID }],
                        });
                        debug('Switched to Base');
                    } catch (switchError) {
                        debug('Switch error:', switchError);
                        if (switchError.code === 4902) {
                            debug('Adding Base network...');
                            try {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: BASE_CHAIN_ID,
                                        chainName: 'Base',
                                        nativeCurrency: {
                                            name: 'Ether',
                                            symbol: 'ETH',
                                            decimals: 18
                                        },
                                        rpcUrls: ['https://mainnet.base.org'],
                                        blockExplorerUrls: ['https://basescan.org/']
                                    }],
                                });
                                debug('Base network added');
                            } catch (addError) {
                                debug('Add network error:', addError);
                                showError('Please add Base network to your wallet');
                                connectButton.disabled = false;
                                connectButton.innerHTML = 'CONNECT';
                                return;
                            }
                        } else {
                            showError('Please switch to Base network');
                            connectButton.disabled = false;
                            connectButton.innerHTML = 'CONNECT';
                            return;
                        }
                    }
                }
                
                // Setup provider
                debug('Setting up provider...');
                provider = new ethers.providers.Web3Provider(window.ethereum);
                const network = await provider.getNetwork();
                debug('Network:', network);
                
                if (network.chainId !== BASE_CHAIN_ID_DEC) {
                    throw new Error('Wrong network after switch');
                }
                
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                debug('User address:', userAddress);
                
                // Setup contract
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                debug('Contract initialized');
                
                // Check if already signed
                try {
                    const hasSigned = await contract.hasSigned(userAddress);
                    debug('Has signed:', hasSigned);
                    
                    if (hasSigned) {
                        const signature = await contract.signatureByAddress(userAddress);
                        showError(`Already signed as: ${signature}`);
                        connectButton.disabled = false;
                        connectButton.innerHTML = 'CONNECT';
                        return;
                    }
                } catch (err) {
                    debug('Error checking signature:', err);
                }
                
                // Success
                connected = true;
                connectButton.innerHTML = 'COSIGN';
                connectButton.disabled = false;
                infoText.textContent = `Connected: ${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
                debug('Connection successful!');
                
                // Check allowlist
                try {
                    const isAllowlistActive = await contract.isAllowlistActive();
                    if (isAllowlistActive) {
                        const timeUntilPublic = await contract.timeUntilPublic();
                        const hours = Math.floor(timeUntilPublic / 3600);
                        const minutes = Math.floor((timeUntilPublic % 3600) / 60);
                        if (hours > 0 || minutes > 0) {
                            infoText.textContent += ` | Allowlist: ${hours}h ${minutes}m remaining`;
                        }
                    }
                } catch (e) {
                    debug('Allowlist check error:', e);
                }
                
            } catch (error) {
                debug('Connection error:', error);
                connectButton.disabled = false;
                connectButton.innerHTML = 'CONNECT';
                showError('Connection failed. Check console for details.');
            }
        }
        
        // Sign declaration
        async function signDeclaration() {
            try {
                clearMessages();
                debug('Starting signature process...');
                
                const name = nameInput.value.trim().toLowerCase();
                
                // Validate
                if (!name) {
                    showError('Please enter a name');
                    return;
                }
                
                if (name.length > 14) {
                    showError('Name cannot exceed 14 characters');
                    return;
                }
                
                if (!/^[a-z0-9-]+$/.test(name)) {
                    showError('Only lowercase letters, numbers, and hyphens allowed');
                    return;
                }
                
                // Check if name exists
                const fullName = `i_am_${name}_dave`;
                debug('Checking name availability:', fullName);
                
                const nameExists = await contract.nameExists(fullName);
                if (nameExists) {
                    showError('This DAVE name is already taken');
                    return;
                }
                
                // Sign
                connectButton.disabled = true;
                connectButton.innerHTML = 'SIGNING<span class="loading-spinner"></span>';
                
                debug('Sending transaction...');
                const tx = await contract.cosignDeclaration(name);
                debug('Transaction sent:', tx.hash);
                
                connectButton.innerHTML = 'CONFIRMING<span class="loading-spinner"></span>';
                
                const receipt = await tx.wait();
                debug('Transaction confirmed:', receipt);
                
                // Success
                successMessage.textContent = `Successfully signed as: ${fullName}`;
                successMessage.style.display = 'block';
                nameInput.value = '';
                connectButton.innerHTML = 'SIGNED';
                connectButton.disabled = true;
                
                // Get signature number
                const event = receipt.events?.find(e => e.event === 'DeclarationSigned');
                if (event) {
                    successMessage.textContent += ` | Signature #${event.args.signatureNumber}`;
                }
                
            } catch (error) {
                debug('Sign error:', error);
                connectButton.disabled = false;
                connectButton.innerHTML = 'COSIGN';
                
                if (error.code === 'ACTION_REJECTED' || error.code === 4001) {
                    showError('Transaction cancelled');
                } else if (error.message?.includes('allowlisted')) {
                    showError('Only allowlisted addresses can sign during this period');
                } else {
                    showError('Transaction failed. Check console for details.');
                }
            }
        }
        
        // Event handlers
        connectButton.addEventListener('click', async () => {
            if (!connected) {
                await connectWallet();
            } else {
                await signDeclaration();
            }
        });
        
        nameInput.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter' && connected) {
                await signDeclaration();
            }
        });
        
        // Listen for account/network changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                debug('Accounts changed:', accounts);
                if (accounts.length === 0) {
                    // Disconnected
                    connected = false;
                    connectButton.innerHTML = 'CONNECT';
                    connectButton.disabled = false;
                    infoText.textContent = '';
                    clearMessages();
                } else if (connected && accounts[0].toLowerCase() !== userAddress.toLowerCase()) {
                    // Account changed - reconnect
                    connected = false;
                    connectWallet();
                }
            });
            
            window.ethereum.on('chainChanged', (chainId) => {
                debug('Chain changed:', chainId);
                if (connected && chainId !== BASE_CHAIN_ID) {
                    showError('Please switch back to Base network');
                    connected = false;
                    connectButton.innerHTML = 'CONNECT';
                    connectButton.disabled = false;
                }
            });
        }
        
        // Auto-focus input
        nameInput.focus();
    </script>
</body>
</html>
