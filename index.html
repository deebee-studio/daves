<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dave Declaration Widget</title>
    
    <!-- Allow embedding in iframes -->
    <meta http-equiv="X-Frame-Options" content="ALLOWALL">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: transparent;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            text-align: center;
            width: 100%;
            max-width: 600px;
        }
        
        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-bottom: 20px;
            min-height: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .error-message.show {
            opacity: 1;
        }
        
        .input-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .prefix, .suffix {
            color: #000;
            font-weight: 400;
        }
        
        .name-input {
            border: 2px solid #000;
            background: #fff;
            padding: 6px 14px;
            font-size: 28px;
            text-align: center;
            min-width: 180px;
            outline: none;
            font-family: inherit;
            transition: all 0.2s ease;
        }
        
        .name-input:focus {
            border-color: #000;
            box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
        }
        
        .connect-button {
            background: #000;
            color: #fff;
            border: none;
            border-radius: 40px;
            padding: 16px 48px;
            font-size: 18px;
            font-weight: 500;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 200px;
            font-family: inherit;
        }
        
        .connect-button:hover:not(:disabled) {
            background: #333;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .connect-button:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .connect-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .info-text {
            color: #666;
            font-size: 14px;
            margin-top: 20px;
        }
        
        .success-message {
            color: #28a745;
            font-size: 16px;
            margin-top: 20px;
            padding: 16px 24px;
            background: #d4edda;
            border-radius: 8px;
            display: none;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
            margin-left: 8px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 600px) {
            .input-wrapper {
                font-size: 20px;
            }
            
            .name-input {
                font-size: 20px;
                min-width: 140px;
                padding: 4px 10px;
            }
            
            .connect-button {
                font-size: 16px;
                padding: 14px 36px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="error-message" id="errorMessage"></div>
        
        <div class="input-wrapper">
            <span class="prefix">i_am_</span>
            <input 
                type="text" 
                class="name-input" 
                id="nameInput" 
                placeholder="your_name" 
                maxlength="14"
                autocomplete="off"
                spellcheck="false"
            >
            <span class="suffix">_dave</span>
        </div>
        
        <button class="connect-button" id="connectButton">CONNECT</button>
        
        <div class="info-text" id="infoText"></div>
        <div class="success-message" id="successMessage"></div>
    </div>

    <script>
        // Load ethers.js with better error handling
        function loadEthers(callback) {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js';
            script.onload = callback;
            script.onerror = function() {
                // Try alternative CDN
                const altScript = document.createElement('script');
                altScript.src = 'https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js';
                altScript.onload = callback;
                altScript.onerror = function() {
                    document.getElementById('errorMessage').textContent = 'Failed to load Web3 library. Please refresh the page.';
                    document.getElementById('errorMessage').classList.add('show');
                };
                document.head.appendChild(altScript);
            };
            document.head.appendChild(script);
        }
        
        // Initialize widget after ethers loads
        loadEthers(function() {
            console.log('[Dave Widget] Ethers loaded successfully');
            
            // Contract details
            const CONTRACT_ADDRESS = '0xB0731E7ea189c169640Fd890E5dcE9811040D0eA';
            const BASE_CHAIN_ID = '0x2105'; // 8453 in hex
            const BASE_CHAIN_ID_DEC = 8453;
            
            const CONTRACT_ABI = [
                "function cosignDeclaration(string memory chosenName) public",
                "function hasSigned(address) public view returns (bool)",
                "function signatureByAddress(address) public view returns (string)",
                "function nameExists(string) public view returns (bool)",
                "function isAllowlistActive() public view returns (bool)",
                "function timeUntilPublic() public view returns (uint256)"
            ];
            
            // State
            let provider = null;
            let signer = null;
            let contract = null;
            let connected = false;
            let userAddress = null;
            
            // Elements
            const connectButton = document.getElementById('connectButton');
            const nameInput = document.getElementById('nameInput');
            const errorMessage = document.getElementById('errorMessage');
            const infoText = document.getElementById('infoText');
            const successMessage = document.getElementById('successMessage');
            
            // Error handling
            function showError(message) {
                console.error('[Dave Widget] Error:', message);
                errorMessage.textContent = message;
                errorMessage.classList.add('show');
                setTimeout(() => {
                    errorMessage.classList.remove('show');
                }, 7000);
            }
            
            function clearMessages() {
                errorMessage.classList.remove('show');
                successMessage.style.display = 'none';
            }
            
            // Connect wallet
            async function connectWallet() {
                try {
                    clearMessages();
                    console.log('[Dave Widget] Starting connection...');
                    
                    // Check for wallet
                    if (typeof window.ethereum === 'undefined') {
                        showError('Please install MetaMask or another Web3 wallet');
                        return;
                    }
                    
                    connectButton.disabled = true;
                    connectButton.innerHTML = 'CONNECTING...';
                    
                    // Request accounts
                    let accounts;
                    try {
                        accounts = await window.ethereum.request({ 
                            method: 'eth_requestAccounts' 
                        });
                        console.log('[Dave Widget] Accounts:', accounts);
                    } catch (err) {
                        if (err.code === -32002) {
                            showError('Please unlock MetaMask');
                        } else if (err.code === 4001) {
                            showError('Connection rejected');
                        } else {
                            showError('Failed to get accounts');
                        }
                        connectButton.disabled = false;
                        connectButton.innerHTML = 'CONNECT';
                        return;
                    }
                    
                    if (!accounts || accounts.length === 0) {
                        throw new Error('No accounts found');
                    }
                    
                    // Get current chain
                    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                    console.log('[Dave Widget] Current chain:', chainId);
                    
                    // Switch to Base if needed
                    if (chainId !== BASE_CHAIN_ID) {
                        try {
                            await window.ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: BASE_CHAIN_ID }],
                            });
                        } catch (switchError) {
                            if (switchError.code === 4902) {
                                try {
                                    await window.ethereum.request({
                                        method: 'wallet_addEthereumChain',
                                        params: [{
                                            chainId: BASE_CHAIN_ID,
                                            chainName: 'Base',
                                            nativeCurrency: {
                                                name: 'Ether',
                                                symbol: 'ETH',
                                                decimals: 18
                                            },
                                            rpcUrls: ['https://mainnet.base.org'],
                                            blockExplorerUrls: ['https://basescan.org/']
                                        }],
                                    });
                                } catch (addError) {
                                    showError('Please add Base network to your wallet');
                                    connectButton.disabled = false;
                                    connectButton.innerHTML = 'CONNECT';
                                    return;
                                }
                            } else {
                                showError('Please switch to Base network');
                                connectButton.disabled = false;
                                connectButton.innerHTML = 'CONNECT';
                                return;
                            }
                        }
                    }
                    
                    // Setup provider - using window.ethers
                    provider = new window.ethers.providers.Web3Provider(window.ethereum);
                    const network = await provider.getNetwork();
                    console.log('[Dave Widget] Network:', network);
                    
                    if (network.chainId !== BASE_CHAIN_ID_DEC) {
                        throw new Error('Wrong network after switch');
                    }
                    
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();
                    console.log('[Dave Widget] User address:', userAddress);
                    
                    // Setup contract
                    contract = new window.ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                    
                    // Check if already signed
                    try {
                        const hasSigned = await contract.hasSigned(userAddress);
                        if (hasSigned) {
                            const signature = await contract.signatureByAddress(userAddress);
                            showError(`Already signed as: ${signature}`);
                            connectButton.disabled = false;
                            connectButton.innerHTML = 'CONNECT';
                            return;
                        }
                    } catch (err) {
                        console.error('[Dave Widget] Error checking signature:', err);
                    }
                    
                    // Success
                    connected = true;
                    connectButton.innerHTML = 'COSIGN';
                    connectButton.disabled = false;
                    infoText.textContent = `Connected: ${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
                    console.log('[Dave Widget] Connection successful!');
                    
                    // Check allowlist
                    try {
                        const isAllowlistActive = await contract.isAllowlistActive();
                        if (isAllowlistActive) {
                            const timeUntilPublic = await contract.timeUntilPublic();
                            const hours = Math.floor(timeUntilPublic / 3600);
                            const minutes = Math.floor((timeUntilPublic % 3600) / 60);
                            if (hours > 0 || minutes > 0) {
                                infoText.textContent += ` | Allowlist: ${hours}h ${minutes}m remaining`;
                            }
                        }
                    } catch (e) {
                        console.error('[Dave Widget] Allowlist check error:', e);
                    }
                    
                } catch (error) {
                    console.error('[Dave Widget] Connection error:', error);
                    connectButton.disabled = false;
                    connectButton.innerHTML = 'CONNECT';
                    showError('Connection failed. Please try again.');
                }
            }
            
            // Sign declaration
            async function signDeclaration() {
                try {
                    clearMessages();
                    
                    const name = nameInput.value.trim().toLowerCase();
                    
                    // Validate
                    if (!name) {
                        showError('Please enter a name');
                        return;
                    }
                    
                    if (name.length > 14) {
                        showError('Name cannot exceed 14 characters');
                        return;
                    }
                    
                    if (!/^[a-z0-9-]+$/.test(name)) {
                        showError('Only lowercase letters, numbers, and hyphens allowed');
                        return;
                    }
                    
                    // Check if name exists
                    const fullName = `i_am_${name}_dave`;
                    const nameExists = await contract.nameExists(fullName);
                    if (nameExists) {
                        showError('This DAVE name is already taken');
                        return;
                    }
                    
                    // Sign
                    connectButton.disabled = true;
                    connectButton.innerHTML = 'SIGNING<span class="loading-spinner"></span>';
                    
                    const tx = await contract.cosignDeclaration(name);
                    console.log('[Dave Widget] Transaction sent:', tx.hash);
                    
                    connectButton.innerHTML = 'CONFIRMING<span class="loading-spinner"></span>';
                    
                    const receipt = await tx.wait();
                    console.log('[Dave Widget] Transaction confirmed');
                    
                    // Success
                    successMessage.textContent = `Successfully signed as: ${fullName}`;
                    successMessage.style.display = 'block';
                    nameInput.value = '';
                    connectButton.innerHTML = 'SIGNED';
                    connectButton.disabled = true;
                    
                    // Get signature number
                    const event = receipt.events?.find(e => e.event === 'DeclarationSigned');
                    if (event) {
                        successMessage.textContent += ` | Signature #${event.args.signatureNumber}`;
                    }
                    
                } catch (error) {
                    console.error('[Dave Widget] Sign error:', error);
                    connectButton.disabled = false;
                    connectButton.innerHTML = 'COSIGN';
                    
                    if (error.code === 'ACTION_REJECTED' || error.code === 4001) {
                        showError('Transaction cancelled');
                    } else if (error.message?.includes('allowlisted')) {
                        showError('Only allowlisted addresses can sign during this period');
                    } else {
                        showError('Transaction failed. Please try again.');
                    }
                }
            }
            
            // Event handlers
            connectButton.addEventListener('click', async () => {
                if (!connected) {
                    await connectWallet();
                } else {
                    await signDeclaration();
                }
            });
            
            nameInput.addEventListener('keypress', async (e) => {
                if (e.key === 'Enter' && connected) {
                    await signDeclaration();
                }
            });
            
            // Listen for account/network changes
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        connected = false;
                        connectButton.innerHTML = 'CONNECT';
                        connectButton.disabled = false;
                        infoText.textContent = '';
                        clearMessages();
                    } else if (connected && accounts[0].toLowerCase() !== userAddress.toLowerCase()) {
                        connected = false;
                        connectWallet();
                    }
                });
                
                window.ethereum.on('chainChanged', (chainId) => {
                    if (connected && chainId !== BASE_CHAIN_ID) {
                        showError('Please switch back to Base network');
                        connected = false;
                        connectButton.innerHTML = 'CONNECT';
                        connectButton.disabled = false;
                    }
                });
            }
            
            // Auto-focus input
            nameInput.focus();
        });
    </script>
</body>
</html>
